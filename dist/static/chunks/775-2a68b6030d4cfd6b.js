"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[775],{2808:(e,r,t)=>{t.d(r,{O:()=>u,A:()=>i});var s=t(5155),o=t(2115);t(4197),t(5112);var a=t(9310),n=t(9770);let c=function(e){let r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};(0,n.$s)(e,r)},l=(0,o.createContext)({user:null,loading:!0,isAuthenticated:!1,login:async(e,r)=>{},logout:()=>{}}),i=()=>(0,o.useContext)(l);function u(e){let{children:r}=e,[t,n]=(0,o.useState)(null),[i,u]=(0,o.useState)(!0);(0,o.useEffect)(()=>{(()=>{try{let e=localStorage.getItem("user");e&&n(JSON.parse(e)),u(!1)}catch(e){console.error("Error checking localStorage:",e),u(!1)}})()},[]);let d={user:t,loading:i,isAuthenticated:!!t,login:async(e,r)=>{console.log("Login function called with username:",e);try{let t=await (0,a.Lx)(e,r);if(t&&t.success){localStorage.setItem("user",JSON.stringify(t.user)),n(t.user);try{c("user_login",{userId:t.user.uid,username:e,role:t.user.role,name:t.user.displayName,timestamp:new Date().toISOString(),action:"Login success"})}catch(e){console.warn("Login logging failed:",e)}}return t}catch(e){return console.error("Login error:",e),{success:!1,error:e.message||"เกิดข้อผิดพลาดในการเข้าสู่ระบบ"}}},logout:()=>{try{let e=null==t?void 0:t.uid;return localStorage.removeItem("user"),n(null),c("user_logout",{userId:e,username:null==t?void 0:t.username,role:null==t?void 0:t.role,name:null==t?void 0:t.displayName,timestamp:new Date().toISOString(),action:"Logout success"}),!0}catch(e){return console.error("Logout error:",e),!1}}};return console.log("AuthContext value:",{user:!!d.user,loading:d.loading,isAuthenticated:d.isAuthenticated,hasLogin:"function"==typeof d.login,hasLogout:"function"==typeof d.logout}),(0,s.jsx)(l.Provider,{value:d,children:r})}},4197:(e,r,t)=>{t.d(r,{db:()=>c});var s=t(3915),o=t(5112),a=t(7051);let n=(0,s.Dk)().length?(0,s.Dk)()[0]:(0,s.Wp)({apiKey:"AIzaSyB9sZFJSn8cvkos5fysi47VpqJc5AsorA4",authDomain:"manpower-patient-summary.firebaseapp.com",projectId:"manpower-patient-summary",storageBucket:"manpower-patient-summary.firebasestorage.app",messagingSenderId:"644057496880",appId:"1:644057496880:web:6270efc29187b9c025dcf5"}),c=(0,o.aU)(n);(0,a.xI)(n)},7775:(e,r,t)=>{t.d(r,{A:()=>l});var s=t(5155),o=t(2115),a=t(5695),n=t(2808),c=t(4776);function l(e){let{children:r,requiredRole:t=null}=e,{user:l,loading:i,isAuthenticated:u}=(0,n.A)(),d=(0,a.useRouter)(),[g,m]=(0,o.useState)(!1),[h,p]=(0,o.useState)(!0),[y,f]=(0,o.useState)(!1);return((0,o.useEffect)(()=>{p(!1);try{if(!i){var e;console.log("AuthGuard checking auth:",{isAuthenticated:u,user:l,requiredRole:t}),u?"admin"===t&&(null==l?void 0:null===(e=l.role)||void 0===e?void 0:e.toLowerCase())!=="admin"?(console.log("User does not have admin role"),f(!0),m(!1)):(console.log("User is authenticated and authorized"),m(!0),f(!1)):(console.log("Not authenticated, redirecting to login"),d.push("/login"))}}catch(e){console.error("Error in AuthGuard:",e),m(!1)}},[i,u,l,d,t]),h)?(0,s.jsx)("div",{className:"min-h-screen"}):y?(0,s.jsx)("div",{className:"min-h-screen bg-gray-50 flex items-center justify-center p-4",children:(0,s.jsxs)("div",{className:"max-w-md w-full bg-white rounded-lg shadow p-8 text-center",children:[(0,s.jsx)("div",{className:"text-red-500 text-5xl mb-4",children:"⚠️"}),(0,s.jsx)("h1",{className:"text-2xl font-bold text-gray-800 mb-4",children:"ไม่ได้เข้า"}),(0,s.jsxs)("p",{className:"text-gray-600 mb-6",children:["ไม่ได้เข้าหน้านี้ เนื่องจากต้องมีบทบาทเป็น ",t]}),(0,s.jsx)("button",{onClick:()=>d.push("/"),className:"px-4 py-2 bg-[#0ab4ab] text-white rounded-md hover:bg-[#0ab4ab]/90",children:"หน้าแรก"})]})}):i||!g?(console.log("Still loading or not authorized yet, showing LoadingScreen"),(0,s.jsx)(c.A,{})):(console.log("Rendering children - user authorized"),(0,s.jsx)(s.Fragment,{children:r}))}},9310:(e,r,t)=>{t.d(r,{CF:()=>n,Lx:()=>a,TK:()=>l,hG:()=>i,nu:()=>c});var s=t(5112),o=t(4197);localStorage.removeItem("useMockData"),localStorage.setItem("useMockData","false");let a=async(e,r)=>{try{let t=(0,s.rJ)(o.db,"users"),a=(0,s.P)(t,(0,s._M)("username","==",e)),n=await (0,s.GG)(a);if(n.empty)return console.log("User not found in database:",e),{success:!1,error:"User not found"};let c=n.docs[0].data(),l=n.docs[0].id;if(console.log("Found user:",e,"Checking password..."),c.password!==r)return console.log("Invalid password for user:",e),{success:!1,error:"Invalid password"};return console.log("Login successful for user:",e),{success:!0,user:{uid:l,...c}}}catch(e){return console.error("Login error:",e.message),{success:!1,error:"Login failed: "+e.message}}},n=async()=>{try{let e=(0,s.rJ)(o.db,"users");return(await (0,s.GG)(e)).docs.map(e=>({id:e.id,...e.data()}))}catch(e){return console.error("Error getting users:",e.message),[]}},c=async e=>{try{let r={...e,createdAt:(0,s.O5)(),updatedAt:(0,s.O5)()},t=await (0,s.gS)((0,s.rJ)(o.db,"users"),r);return{success:!0,id:t.id}}catch(e){return console.error("Error adding user:",e.message),{success:!1,error:e.message}}},l=async(e,r)=>{try{let t={...r,updatedAt:(0,s.O5)()};return await (0,s.mZ)((0,s.H9)(o.db,"users",e),t),{success:!0}}catch(e){return console.error("Error updating user:",e.message),{success:!1,error:e.message}}},i=async e=>{try{return await (0,s.kd)((0,s.H9)(o.db,"users",e)),{success:!0}}catch(e){return console.error("Error deleting user:",e.message),{success:!1,error:e.message}}}},9770:(e,r,t)=>{t.d(r,{$s:()=>n});var s=t(9509);let o="app_logs",a=async e=>{try{let r=await fetch("/api/logs",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)});if(!r.ok)throw Error("Server responded with status ".concat(r.status));return!0}catch(e){return console.warn("Failed to send log to server:",e),!1}},n=async function(e){let r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};try{let t={timestamp:new Date().toISOString(),event:e,properties:r},n=JSON.parse(localStorage.getItem(o)||"[]");n.push(t);let c=n.slice(-1e3);localStorage.setItem(o,JSON.stringify(c)),a(t).catch(e=>{console.warn("Error sending log to server:",e)}),s.env.NEXT_PUBLIC_EXTERNAL_LOGGING_URL&&fetch(s.env.NEXT_PUBLIC_EXTERNAL_LOGGING_URL,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)}).catch(console.error)}catch(e){console.warn("Logging failed:",e)}}}}]);
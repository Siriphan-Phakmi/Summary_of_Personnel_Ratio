"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[898],{4898:(e,r,s)=>{s.d(r,{A:()=>c});var t=s(5155),a=s(2115),o=s(6046),n=s(1340),l=s(3693);function c(e){let{children:r,requiredRole:s=null}=e,{user:c,loading:i,isAuthenticated:u}=(0,n.A)(),d=(0,o.useRouter)(),[m,g]=(0,a.useState)(!1),[h,p]=(0,a.useState)(!0),[f,x]=(0,a.useState)(!1);return((0,a.useEffect)(()=>{p(!1);try{if(!i){var e;console.log("AuthGuard checking auth:",{isAuthenticated:u,user:c,requiredRole:s}),u?"admin"===s&&(null==c?void 0:null===(e=c.role)||void 0===e?void 0:e.toLowerCase())!=="admin"?(console.log("User does not have admin role"),x(!0),g(!1)):(console.log("User is authenticated and authorized"),g(!0),x(!1)):(console.log("Not authenticated, redirecting to login"),d.push("/login"))}}catch(e){console.error("Error in AuthGuard:",e),g(!1)}},[i,u,c,d,s]),h)?(0,t.jsx)("div",{className:"min-h-screen"}):f?(0,t.jsx)("div",{className:"min-h-screen bg-gray-50 flex items-center justify-center p-4",children:(0,t.jsxs)("div",{className:"max-w-md w-full bg-white rounded-lg shadow p-8 text-center",children:[(0,t.jsx)("div",{className:"text-red-500 text-5xl mb-4",children:"⚠️"}),(0,t.jsx)("h1",{className:"text-2xl font-bold text-gray-800 mb-4",children:"ไม่ได้เข้า"}),(0,t.jsxs)("p",{className:"text-gray-600 mb-6",children:["ไม่ได้เข้าหน้านี้ เนื่องจากต้องมีบทบาทเป็น ",s]}),(0,t.jsx)("button",{onClick:()=>d.push("/"),className:"px-4 py-2 bg-[#0ab4ab] text-white rounded-md hover:bg-[#0ab4ab]/90",children:"หน้าแรก"})]})}):i||!m?(console.log("Still loading or not authorized yet, showing LoadingScreen"),(0,t.jsx)(l.A,{})):(console.log("Rendering children - user authorized"),(0,t.jsx)(t.Fragment,{children:r}))}},3693:(e,r,s)=>{s.d(r,{A:()=>o});var t=s(5155);s(2115);var a=s(5565);let o=()=>(0,t.jsx)("div",{className:"fixed inset-0 bg-gradient-to-br from-white via-blue-50 to-[#0ab4ab]/10 flex items-center justify-center z-50",children:(0,t.jsx)("div",{className:"bg-white/80 p-8 rounded-2xl shadow-xl backdrop-blur-sm",children:(0,t.jsxs)("div",{className:"text-center",children:[(0,t.jsx)("div",{className:"relative w-32 h-32 mx-auto mb-4",children:(0,t.jsx)(a.default,{src:"/images/BPK.jpg",alt:"BPK Loading",fill:!0,style:{objectFit:"contain"},className:"animate-pulse rounded-lg",priority:!0})}),(0,t.jsxs)("div",{className:"flex flex-col items-center",children:[(0,t.jsx)("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-[#0ab4ab] mb-3"}),(0,t.jsx)("p",{className:"text-gray-600 font-medium",children:"กำลังโหลดข้อมูล..."}),(0,t.jsx)("p",{className:"text-sm text-gray-500 mt-1",children:"โปรดรอสักครู่"})]})]})})})},1340:(e,r,s)=>{s.d(r,{A:()=>c,O:()=>i});var t=s(5155),a=s(2115);s(7982),s(7058);var o=s(9525),n=s(6772);let l=(0,a.createContext)({}),c=()=>(0,a.useContext)(l);function i(e){let{children:r}=e,[s,c]=(0,a.useState)(null),[i,u]=(0,a.useState)(!0);(0,a.useEffect)(()=>{(()=>{try{let e=localStorage.getItem("user");e&&c(JSON.parse(e)),u(!1)}catch(e){console.error("Error checking localStorage:",e),u(!1)}})()},[]);let d=async(e,r)=>{try{let s=await (0,o.Lx)(e,r);if(s&&s.success){localStorage.setItem("user",JSON.stringify(s.user)),c(s.user);try{(0,n.$s)("user_login",{userId:s.user.uid,timestamp:new Date().toISOString()})}catch(e){console.warn("Login logging failed:",e)}}return s}catch(e){return console.error("Login error:",e),{success:!1,error:e.message}}},m=null!==s;return(0,t.jsx)(l.Provider,{value:{user:s,loading:i,isAuthenticated:m,login:d,logout:()=>{try{let e=null==s?void 0:s.uid;return localStorage.removeItem("user"),c(null),(0,n.$s)("user_logout",{userId:e,timestamp:new Date().toISOString()}),!0}catch(e){return console.error("Logout error:",e),!1}}},children:r})}},9525:(e,r,s)=>{s.d(r,{CF:()=>n,F7:()=>u,Lx:()=>o,TK:()=>c,hG:()=>i,nu:()=>l});var t=s(7058),a=s(7982);localStorage.removeItem("useMockData"),localStorage.setItem("useMockData","false");let o=async(e,r)=>{try{let s=(0,t.rJ)(a.db,"users"),o=(0,t.P)(s,(0,t._M)("username","==",e)),n=await (0,t.GG)(o);if(n.empty)return console.log("User not found in database:",e),{success:!1,error:"User not found"};let l=n.docs[0].data(),c=n.docs[0].id;if(console.log("Found user:",e,"Checking password..."),l.password!==r)return console.log("Invalid password for user:",e),{success:!1,error:"Invalid password"};return console.log("Login successful for user:",e),{success:!0,user:{uid:c,...l}}}catch(e){return console.error("Login error:",e.message),{success:!1,error:"Login failed: "+e.message}}},n=async()=>{try{let e=(0,t.rJ)(a.db,"users");return(await (0,t.GG)(e)).docs.map(e=>({id:e.id,...e.data()}))}catch(e){return console.error("Error getting users:",e.message),[]}},l=async e=>{try{let r={...e,createdAt:(0,t.O5)(),updatedAt:(0,t.O5)()},s=await (0,t.gS)((0,t.rJ)(a.db,"users"),r);return{success:!0,id:s.id}}catch(e){return console.error("Error adding user:",e.message),{success:!1,error:e.message}}},c=async(e,r)=>{try{let s={...r,updatedAt:(0,t.O5)()};return await (0,t.mZ)((0,t.H9)(a.db,"users",e),s),{success:!0}}catch(e){return console.error("Error updating user:",e.message),{success:!1,error:e.message}}},i=async e=>{try{return await (0,t.kd)((0,t.H9)(a.db,"users",e)),{success:!0}}catch(e){return console.error("Error deleting user:",e.message),{success:!1,error:e.message}}},u=async()=>{try{let e=(await n()).map(async e=>{let r={};if((!e.firstName||!e.lastName)&&e.fullName){let s=(e.fullName||"").split(" ");r.firstName=s[0]||"",r.lastName=s.slice(1).join(" ")||""}return(e.position||(e.role&&"admin"===e.role.toLowerCase()?r.position="ผู้ดูแลระบบ":r.position="เจ้าหน้าที่พยาบาล"),Object.keys(r).length>0)?(r.updatedAt=(0,t.O5)(),(0,t.mZ)((0,t.H9)(a.db,"users",e.id),r)):Promise.resolve()});return await Promise.all(e),{success:!0,message:"Updated all users successfully"}}catch(e){return console.error("Error updating users:",e.message),{success:!1,error:e.message}}}},7982:(e,r,s)=>{s.d(r,{db:()=>l});var t=s(9904),a=s(7058),o=s(4565);let n=(0,t.Dk)().length?(0,t.Dk)()[0]:(0,t.Wp)({apiKey:"AIzaSyB9sZFJSn8cvkos5fysi47VpqJc5AsorA4",authDomain:"manpower-patient-summary.firebaseapp.com",projectId:"manpower-patient-summary",storageBucket:"manpower-patient-summary.firebasestorage.app",messagingSenderId:"644057496880",appId:"1:644057496880:web:6270efc29187b9c025dcf5"}),l=(0,a.aU)(n);(0,o.xI)(n)},6772:(e,r,s)=>{s.d(r,{$s:()=>n});var t=s(7358);let a="app_logs",o=function(e){let r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};try{let s={timestamp:new Date().toISOString(),event:e,properties:r},o=JSON.parse(localStorage.getItem(a)||"[]");o.push(s);let n=o.slice(-1e3);localStorage.setItem(a,JSON.stringify(n)),t.env.NEXT_PUBLIC_EXTERNAL_LOGGING_URL&&fetch(t.env.NEXT_PUBLIC_EXTERNAL_LOGGING_URL,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(s)}).catch(console.error)}catch(e){console.warn("Logging failed:",e)}},n=function(e){let r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};o(e,r)}}}]);
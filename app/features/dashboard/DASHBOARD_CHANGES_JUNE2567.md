# การแก้ไขระบบ Dashboard และการบันทึกข้อมูล DailySummary (มิถุนายน 2567)

## ปัญหาที่พบ
- ค่า Available Beds (เตียงว่าง), Unavailable Beds (เตียงไม่ว่าง) และ Planned Discharge (วางแผนจำหน่าย) ไม่ได้ถูกบันทึกและส่งไปยัง DailySummaries อย่างถูกต้อง
- เมื่อดึงข้อมูลมาแสดงใน Dashboard ค่าดังกล่าวเป็น 0 ทำให้ไม่มีข้อมูลแสดง
- ข้อมูลกะเช้าที่อนุมัติแล้วไม่แสดงในหน้า Dashboard
- มีการใช้ค่า default จำนวนเตียง 20 เตียงเมื่อไม่มีข้อมูลจริง ทำให้แสดงข้อมูลไม่ถูกต้อง

## การแก้ไข

### 1. แก้ไขการบันทึกข้อมูลใน dailySummary.ts:
- แก้ไขการสร้าง DailySummary ในฟังก์ชัน `checkAndCreateDailySummary` ให้บันทึกค่า availableBeds, unavailableBeds และ plannedDischarge จากทั้งกะเช้าและกะดึก
- ปรับการอัพเดตข้อมูลในฟังก์ชัน `updateDailySummary` ให้คงค่าข้อมูลเตียงที่ไม่เป็น 0 ไว้ โดยเลือกข้อมูลจากกะที่ใหม่กว่า (กะดึก) ก่อนเสมอ
- เพิ่มการอัพเดตค่าในแต่ละกะเมื่อมีการเปลี่ยนแปลงของข้อมูล (ทั้งกะเช้าและกะดึก)

### 2. แก้ไขการแสดงผลข้อมูลใน Dashboard:
- แก้ไขฟังก์ชัน `getWardFormsByDateAndWard` ให้ดึงข้อมูลกะเช้าและกะดึกแยกกัน เพื่อให้ค้นหาข้อมูลได้แม่นยำมากขึ้น
- เพิ่มการค้นหาแบบเฉพาะเจาะจงตามกะและสถานะ (FINAL, APPROVED) เพื่อให้แสดงข้อมูลกะเช้าที่อนุมัติแล้วได้ถูกต้อง
- ปรับปรุงลอจิกการค้นหาให้มีประสิทธิภาพมากขึ้น โดยใช้ limit(1) เพื่อดึงเฉพาะข้อมูลล่าสุด

### 3. แก้ไขการใช้ค่าดีฟอลต์ในการแสดงจำนวนเตียง:
- ยกเลิกการใช้ค่า default จำนวนเตียง 20 เตียง ในทุกส่วนของโค้ด
- แก้ไขฟังก์ชัน `fetchAllWardSummaryData` ให้ใช้ค่าจริงเท่านั้น ไม่ใช้ค่า default
- แก้ไขการแสดงผลใน BedSummaryPieChart ให้แสดงเฉพาะค่าจริงที่มีในระบบ
- ปรับปรุงการตรวจสอบความสมบูรณ์ของข้อมูลให้ใช้ค่า 0 เมื่อไม่มีข้อมูลจริง แทนการใช้ค่า default

## ผลลัพธ์
- ข้อมูลกะเช้าที่อนุมัติแล้วแสดงในหน้า Dashboard ได้ถูกต้อง
- ไม่มีการแสดงจำนวนเตียงเป็น 20 เตียงเมื่อไม่มีข้อมูลจริง
- ข้อมูลที่แสดงในหน้า Dashboard เป็นข้อมูลจริงทั้งหมด ไม่มีข้อมูล default
- การบันทึกและการแสดงผลข้อมูลมีความสอดคล้องกันมากขึ้น

## ความปลอดภัยของข้อมูล
- การแก้ไขไม่กระทบต่อความปลอดภัยของข้อมูล เนื่องจากเป็นเพียงการปรับปรุงกระบวนการเก็บและแสดงผลข้อมูลที่มีอยู่เดิม
- ข้อมูลยังคงผ่านการตรวจสอบและอนุมัติตามกระบวนการเดิม
- ไม่มีการเพิ่มหรือลบฟิลด์ใดๆ ในฐานข้อมูล เป็นเพียงการปรับปรุงวิธีการเข้าถึงและบันทึกข้อมูลที่มีอยู่แล้ว 

## การปรับปรุง Dashboard มิถุนายน 2567

### การแก้ไขปัญหา (29 มิถุนายน 2567)

1. แก้ไขปัญหาการแสดงข้อมูล WardForm ที่ไม่ถูกต้อง
   - แก้ไขฟังก์ชัน `getWardFormsByDateAndWard` ให้ค้นหาแบบแยกกะเช้า/กะดึก
   - ปรับการค้นหาให้เจาะจงตามกะและสถานะ (FINAL, APPROVED)

2. แก้ไขปัญหา reference error ของ `bedSummaryData` โดยใช้ `pieChartData` แทน
   - เปลี่ยนทุกจุดที่อ้างอิงถึง `bedSummaryData` ให้ใช้ `pieChartData` แทน
   - เพิ่มการตรวจสอบความถูกต้องของข้อมูลก่อนแสดงผล

3. กำจัดการใช้ค่า default 20 เตียงสำหรับทุก ward
   - แก้ไขทุกจุดที่ใช้ค่า default 20 เตียง ให้ใช้ค่า 0 เมื่อไม่มีข้อมูลจริง
   - เพิ่มการตรวจสอบความสมบูรณ์ของข้อมูลและใช้ค่า 0 เมื่อไม่พบข้อมูล

4. ปรับปรุงประสิทธิภาพการโหลดข้อมูลสำหรับ Dashboard
   - ลดการเรียก API ซ้ำซ้อน
   - เพิ่ม cache ข้อมูลในบางส่วนเพื่อลดการเรียกข้อมูลซ้ำ

5. แก้ไขการแสดงค่า unavailableBeds ให้ถูกต้อง
   - ปรับการแสดงข้อมูลจำนวนเตียงทั้งหมดให้ถูกต้อง
   - ไม่ใช้ค่า default ที่ไม่ถูกต้องอีกต่อไป

### การปรับปรุงสำหรับผู้ใช้ทั่วไป (30 มิถุนายน 2567)

1. ปรับปรุงการแสดงผลสำหรับผู้ใช้ทั่วไป (ไม่ใช่ admin)
   - เพิ่มตัวแปร `isRegularUser` เพื่อตรวจสอบประเภทผู้ใช้
   - ผู้ใช้ทั่วไปจะเห็นเฉพาะข้อมูลของ Ward ที่ตนเองสังกัด
   - แสดงชื่อแผนกของผู้ใช้ในหัวข้อ Dashboard

2. ปรับปรุงการแสดงข้อมูลตามบทบาทของผู้ใช้
   - เพิ่ม prop `isRegularUser` ใน component WardCensusButtons เพื่อกำหนดการแสดงปุ่มที่เหมาะสม
   - ปรับปรุง component WardSummaryTable ให้แสดงข้อมูลเฉพาะแผนกของผู้ใช้ทั่วไป
   - กรองข้อมูลกราฟ Patient Census ให้แสดงเฉพาะข้อมูลของ Ward ของผู้ใช้ทั่วไป
   - กรองข้อมูลกราฟวงกลมจำนวนเตียงให้แสดงเฉพาะข้อมูลของ Ward ของผู้ใช้ทั่วไป

3. ปรับปรุงการทำงาน handleSelectWard สำหรับผู้ใช้ทั่วไป
   - ผู้ใช้ทั่วไปไม่สามารถเลือก Ward อื่นนอกเหนือจาก Ward ของตนเองได้
   - เพิ่มการตรวจสอบสิทธิ์ในการเข้าถึง Ward ที่เลือก 

### การปรับปรุงเพิ่มเติม (กรกฎาคม 2567)

1. แก้ไขปัญหา Patient Census (คงพยาบาล) ตามแผนกที่ไม่แสดงข้อมูลกะเช้าหลังอนุมัติแล้ว
   - แก้ไขการใช้ข้อมูลใน bedCensusArr โดยเปลี่ยนจากการใช้ available เป็น patientCensus
   - ปรับปรุง function ที่ดึงข้อมูลสำหรับกราฟแท่งให้ใช้ค่า patientCensus แทน available
   - ปรับปรุง wardCensusData ใน useMemo เพื่อให้ดึงข้อมูลจากหลายแหล่งอย่างถูกต้อง
   - เพิ่มการตรวจสอบข้อมูลเวรเช้าและเวรดึกโดยละเอียด และเพิ่มการบันทึก logs เพื่อการแก้ไขปัญหา
   - ปรับปรุงวิธีการคำนวณจำนวนผู้ป่วยรวมให้ใช้ผลรวมของเวรเช้าและเวรดึกที่ถูกต้อง

2. ปรับปรุงการแสดงวันที่ปัจจุบันในปฏิทินให้ชัดเจนขึ้น
   - เพิ่มขนาดวันที่จาก text-[10px] เป็น text-xs font-bold
   - เพิ่มกรอบสีและพื้นหลังสำหรับวันที่ปัจจุบัน
   - ปรับขนาดตัวเลขวันที่ให้แสดงในวงกลมขนาด w-5 h-5

3. เพิ่มขนาดสีสถานะของรายงานให้เห็นชัดเจนขึ้น
   - เพิ่มขนาดจุดสีแสดงสถานะใต้วันที่จาก w-1.5 h-1.5 เป็น w-2.5 h-2.5

4. ปรับปรุงการทำงานของปุ่ม "แสดงแยกแผนก" ในแนวโน้มผู้ป่วย
   - เพิ่มการบันทึกสถานะการแสดงผลใน localStorage เพื่อจำค่าการตั้งค่าไว้
   - เพิ่มคำอธิบายการใช้งานปุ่ม "แสดงแยกแผนก"

5. ปรับปรุงส่วนแสดงผล "จำนวนผู้ป่วย (ตามหอผู้ป่วย)" และ "เปรียบเทียบเวรเช้า-ดึก"
   - เปลี่ยนให้ต้องเลือก Ward ก่อนจึงจะแสดงข้อมูล
   - เพิ่มตัวเลือก Ward สำหรับผู้ดูแลระบบเพื่อให้เลือกข้อมูลได้ง่ายขึ้น
   - ปรับปรุงหน้าตาให้มีคำแนะนำและปุ่มเลือก Ward ที่ชัดเจน

6. เพิ่มคำอธิบายเพิ่มเติมในกราฟแท่ง Patient Census
   - เพิ่มสัญลักษณ์สีอธิบายความหมายของแท่งกราฟสำหรับเวรเช้าและเวรดึก 

# การปรับปรุง Dashboard - มิถุนายน 2567

## ปัญหาที่พบและการแก้ไข

### 1. ข้อมูลกะเช้าที่อนุมัติแล้วไม่แสดงในหน้า Dashboard
- แก้ไขโดยปรับปรุงการแสดงผลข้อมูลจาก dailySummaries และ wardForms 
- เพิ่มการดึงข้อมูลกะเช้าจากทั้งสองแหล่งอย่างถูกต้อง

### 2. ปัญหาการแสดงจำนวนผู้ป่วย (Patient Census)
- แก้ไขจากการใช้ `available` เป็นการใช้ `patientCensus` 
- ปรับปรุง `wardCensusData` ใน useMemo เพื่อดึงข้อมูลจากหลายแหล่ง

### 3. ปุ่ม "แสดงแยกแผนก" ไม่ทำงาน
- เพิ่มการบันทึกสถานะการแสดงผลใน localStorage
- แก้ไข logic ในส่วนของ PatientTrendChart

### 4. แก้ไขการใช้ค่าดีฟอลต์ในกรณีไม่มีข้อมูล
- เปลี่ยนจากการใช้ค่าดีฟอลต์ 20 เตียงเป็นการใช้ค่า 0 หรือข้อมูลจริงเท่านั้น
- ปรับปรุงการแสดงข้อมูลในส่วน "จำนวนผู้ป่วย" และ "เปรียบเทียบเวรเช้า-ดึก"

### 5. ปรับปรุงสำหรับผู้ใช้ทั่วไป (ไม่ใช่ admin)
- ให้แสดงเฉพาะข้อมูล Ward ของตนเองเท่านั้น
- ปรับปรุงปุ่ม "เลือกแผนก" ให้แสดงเฉพาะ Ward ที่มีสิทธิ์

### 6. ปรับปรุง UI/UX
- เพิ่มขนาดสีสถานะของรายงานให้เห็นชัดเจนขึ้น
- ปรับปรุงการแสดงวันที่ปัจจุบันในปฏิทินให้ชัดเจนขึ้น
- เพิ่มคำอธิบายการใช้งานในส่วนต่างๆ

## การเปลี่ยนแปลงในโค้ด

1. แก้ไขการดึงข้อมูลจาก `wardForms` โดยการเพิ่ม query เฉพาะเจาะจงแยกตามกะ
2. ปรับปรุงการคำนวณข้อมูลสำหรับกราฟใน `calculateBedSummary()`
3. แก้ไขวิธีการแสดงผลข้อมูลในส่วน `wardCensusData`
4. เพิ่มการบันทึกสถานะการแสดงผลใน localStorage สำหรับปุ่ม "แสดงแยกแผนก"
5. ปรับปรุงเงื่อนไขการแสดงข้อมูลสำหรับผู้ใช้ทั่วไปและผู้ดูแลระบบ

## การแก้ไขโครงสร้างไฟล์
- แก้ไขความผิดพลาดในการเขียนโค้ด JSX ที่อยู่นอก return statement
- ปรับปรุงการจัดเรียง component ใน return statement ให้เป็นระเบียบ
- ลบโค้ดที่ซ้ำซ้อนออก 

## แก้ไขวันที่ [วันที่ปัจจุบัน]

### ปัญหาที่แก้ไข
1. แก้ไขปัญหาข้อมูลเวรเช้าที่อนุมัติแล้วไม่แสดงใน Dashboard
   - แก้ไขฟังก์ชัน `fetchCensusData` เพื่อดึงข้อมูลเวรเช้าจากทั้ง WardForms และ DailySummaries
   - ปรับปรุงฟังก์ชัน `refreshData` ให้ดึงข้อมูลเวรเช้าที่อนุมัติแล้วมาแสดงอย่างถูกต้อง
   - แก้ไข useMemo ของ `wardCensusData` ให้ใช้ข้อมูลจาก `bedCensusData` แทนการใช้ค่าประมาณการ

2. แก้ไขปัญหาเมื่อกดปุ่ม "แสดงแยกแผนก" แล้วข้อมูลไม่แสดง
   - แก้ไขข้อความในปุ่มใน PatientTrendChart.tsx ให้ตรงกับการทำงาน
   - แก้จากเดิม: เมื่อ showWardDetails เป็น true แสดง "แสดงแยกแผนก" เป็น "แสดงภาพรวม"
   - แก้จากเดิม: เมื่อ showWardDetails เป็น false แสดง "แสดงภาพรวม" เป็น "แสดงแยกแผนก"

### รายละเอียดการแก้ไข
1. ปรับปรุงการดึงข้อมูลเวรเช้า-ดึก
   - เพิ่มการดึงข้อมูลจาก `getDailySummary` เพื่อเป็นข้อมูลเสริมในกรณีที่ `getWardFormsByDateAndWard` ไม่พบข้อมูล
   - เพิ่ม logging เพื่อตรวจสอบข้อมูลที่ดึงมาแสดง
   - ปรับปรุงโครงสร้างข้อมูล `bedCensusData` เพื่อให้แสดงข้อมูลได้ถูกต้อง

2. ปรับปรุงการแสดงผลแยกแผนก
   - แก้ไขข้อความในปุ่มให้ตรงกับการทำงานจริง
   - เพิ่มความชัดเจนของการแสดงผลแยกแผนกหรือแสดงภาพรวม

3. ปรับปรุงประสิทธิภาพการดึงข้อมูล
   - ใช้ข้อมูลจาก `bedCensusData` แทนการใช้ค่าประมาณการใน `wardCensusData`
   - เพิ่มการตรวจสอบข้อมูลที่ซ้ำซ้อนเพื่อป้องกันการดึงข้อมูลซ้ำ

### ผลลัพธ์
- ข้อมูลเวรเช้าที่อนุมัติแล้วแสดงใน Dashboard อย่างถูกต้อง
- ปุ่ม "แสดงแยกแผนก" ทำงานได้อย่างถูกต้อง
- การแสดงผลข้อมูลมีความเสถียรและแม่นยำมากขึ้น 
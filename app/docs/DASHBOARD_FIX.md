# การแก้ไขปัญหาการแสดงข้อมูลในหน้า Dashboard

## ประเด็นปัญหา

พบปัญหาการแสดงข้อมูลในหน้า Dashboard โดยข้อมูลที่บันทึกแล้วเป็น "Final" หรือได้รับการอนุมัติแล้ว ไม่ปรากฏในหน้า Dashboard หลังจากการอนุมัติ

## สาเหตุของปัญหา

1. **การ Query ข้อมูลไม่ถูกต้อง**: ในไฟล์ `DashboardPage.tsx` มีการใช้ query ที่มีเงื่อนไขซับซ้อนหลายข้อ ซึ่งอาจไม่ตรงกับ compound index ที่มีอยู่ใน Firestore
2. **ค่า `allFormsApproved` ไม่ถูกอัปเดต**: มีความเป็นไปได้ว่าฟิลด์ `allFormsApproved` ไม่ได้ถูกอัปเดตเป็น `true` เมื่อแบบฟอร์มทั้งกะเช้าและกะดึกได้รับการอนุมัติ
3. **การปรับโครงสร้างโค้ด**: การย้ายไฟล์และโฟลเดอร์อาจทำให้ path การ import ไม่ถูกต้อง ส่งผลให้การเรียกใช้ฟังก์ชันไม่ทำงานตามที่คาดหวัง

## การแก้ไข

1. **ปรับวิธีการ Query ข้อมูล**:
   - แก้ไขไฟล์ `DashboardPage.tsx` ให้ใช้ฟังก์ชัน `getApprovedSummariesByDateRange` จาก `dailySummary.ts` แทนการ query ตรงไปยัง Firestore
   - ฟังก์ชัน `getApprovedSummariesByDateRange` ได้รับการปรับปรุงให้ใช้ `dateString` สำหรับการ query ตามช่วงวันที่ และมีกลไก fallback

2. **ปรับปรุงฟังก์ชัน `getApprovedSummariesByDateRange`**:
   - แก้ไขให้ Query โดยใช้ `dateString` เพื่อความแม่นยำในการกรองตามช่วงวันที่
   - มีการจัดการตั้งค่า `allFormsApproved = true` สำหรับข้อมูลที่ดึงมาเพื่อช่วยในการแสดงผลบน Dashboard
   - เพิ่มกลไก fallback ในกรณีที่ query หลักไม่พบข้อมูลในช่วงวันที่ที่แคบ โดยจะ query กว้างขึ้นตาม `wardId` แล้วกรองผลลัพธ์ด้วย JavaScript

3. **ตรวจสอบความถูกต้องของการอัปเดต `allFormsApproved`**:
   - ฟังก์ชัน `checkAndCreateDailySummary` และ `updateDailySummaryApprovalStatus` ใน `approvalForms.ts` และ `dailySummary.ts` มีการตั้งค่า `allFormsApproved = true` ในเอกสาร `dailySummaries` เพื่อให้ข้อมูลแสดงผลบน Dashboard
   - ฟังก์ชัน `approveForm` เรียกใช้ฟังก์ชันดังกล่าวอย่างถูกต้อง

4. **การใช้ `calculatedCensus`**:
    - `DashboardPage.tsx` ได้รับการปรับปรุงให้ความสำคัญกับ `calculatedCensus` (และรูปแบบตามกะ) เมื่อแสดงข้อมูลจำนวนผู้ป่วยใน WardCard และส่วนอื่นๆ

## สิ่งที่ต้องทำต่อ

1. **สร้าง Compound Index เพิ่มเติม (สำคัญมาก)**:
   - สร้าง Compound Index สำหรับ collection `dailySummaries` ที่รองรับการ query ด้วยเงื่อนไข `wardId` (Ascending), `dateString` (Ascending), `allFormsApproved` (Ascending) เพื่อประสิทธิภาพสูงสุด (หรือ `wardId`, `dateString` โดย `allFormsApproved` อาจไม่จำเป็นใน query path หลักอีกต่อไปหากมีการตั้งค่าเป็น `true` เสมอตอนดึงข้อมูล)
   - ที่สำคัญคือ Index สำหรับ query หลักใน `getApprovedSummariesByDateRange`: `wardId` (Ascending), `dateString` (Ascending), `dateString` (Descending) ถ้า Firebase อนุญาตให้มี field เดียวกันสองครั้งสำหรับ range หรือ `wardId` (Ascending), `dateString` (Descending) หาก query หลักเปลี่ยนเป็น order by dateString descending
   - **Index ที่แนะนำล่าสุดสำหรับ `getApprovedSummariesByDateRange` คือ: `wardId` (Ascending), `dateString` (Descending).** หาก Firestore ต้องการ order by field เดียวกับ range query ให้ตรวจสอบอีกครั้ง

2. **ตรวจสอบ Log การทำงานอย่างต่อเนื่อง**:
    - `console.log` ที่เพิ่มเข้าไปช่วยในการตรวจสอบการไหลของข้อมูล ควรคงไว้และตรวจสอบเพิ่มเติมหากยังพบปัญหา

3. **เพิ่มกลไกการแจ้งเตือน**:
   - เพิ่มการแจ้งเตือนแก่ผู้ใช้เมื่อแบบฟอร์มทั้งสองกะได้รับการอนุมัติและข้อมูลพร้อมแสดงในหน้า Dashboard
   - อาจใช้ระบบแจ้งเตือนผ่าน NotificationService ที่มีอยู่แล้ว

4. **ตรวจสอบประสิทธิภาพ**:
   - ติดตามประสิทธิภาพของการ query ข้อมูลหลังการแก้ไข
   - ตรวจสอบว่ากลไก fallback ทำงานได้อย่างถูกต้องหรือไม่

5. **ปรับปรุง Performance ในการดึงข้อมูล**:
   - ใช้ `Promise.all` เพื่อ parallelize การดึงข้อมูล ward forms และ summaries ลดระยะเวลาการรอ
   - ลดการเรียกซ้ำฟังก์ชันที่ดึงข้อมูลเดิมซ้ำหลายครั้ง
   - เพิ่ม Loading Indicator (Spinner) ในส่วน Chart และ Grid โดยใช้ state `loading` เพื่อแสดงสถานะขณะดึงข้อมูล

## การทดสอบ

1. ทดสอบการย้ายระหว่างกะเช้าและกะดึกในแบบฟอร์ม
2. ทดสอบการอนุมัติแบบฟอร์มทั้งกะเช้าและกะดึก
3. ตรวจสอบว่าข้อมูลปรากฏในหน้า Dashboard หลังการอนุมัติ
4. ตรวจสอบว่าข้อมูลแสดงถูกต้องตามช่วงวันที่ที่เลือก

## ผู้รับผิดชอบ

เนื่องจากเป็นการแก้ไขที่เกี่ยวข้องกับการแสดงผลและการอนุมัติข้อมูล ควรได้รับการตรวจสอบโดยผู้ที่เข้าใจทั้งระบบ Dashboard และระบบอนุมัติแบบฟอร์ม 

---

# การปรับปรุงหน้า Dashboard เพิ่มเติม (วันที่ 16 พฤษภาคม 2567)

## ประเด็นที่ปรับปรุง

1. **ปรับปรุงการแสดงผล Dark Mode และ Light Mode**:
   - การแสดงผลบางส่วนในหน้า Dashboard ไม่ปรับเปลี่ยนสีตาม Dark/Light Mode
   - มีปุ่มเปลี่ยน Dark Mode/Light Mode ซ้ำซ้อนกันปรากฏทั้งในหน้า Dashboard และในส่วนล่างของหน้าจอ

2. **ข้อมูลกราฟแท่งและกราฟวงกลม**:
   - บางแผนก/Ward ไม่แสดงในกราฟ (จากทั้งหมด 12 หน่วย: CCU, ICU, LR, NSY, Ward10B, Ward11, Ward12, Ward6, Ward7, Ward8, Ward9, WardGI)
   - กราฟวงกลมแสดงเลขทศนิยมที่มีความยาวเกินไปและไม่จำเป็น
   - บางกรณีกราฟวงกลมไม่แสดงข้อมูลแม้มีจำนวนเตียงว่าง
   - ตัวอักษรในกราฟวงกลมไม่ชัดเจนในโหมดมืด

3. **การแสดงผลตาม Role ของผู้ใช้**:
   - Dashboard ควรแสดงเฉพาะข้อมูลของแผนกที่ผู้ใช้มีสิทธิ์เข้าถึง ยกเว้นผู้ดูแลระบบที่ควรเห็นข้อมูลทั้งหมด

## การแก้ไข

1. **แก้ไขการแสดงผล Dark Mode**:
   - ปรับปรุง CSS ใน `DashboardOverview.tsx` ให้รองรับ Dark Mode ได้อย่างสมบูรณ์
   - ลบปุ่มสลับโหมดสีธีมที่ซ้ำซ้อนในไฟล์ `DashboardPage.tsx` และใช้เฉพาะปุ่มที่อยู่ในไฟล์ `app/layout.tsx` ซึ่งใช้คอมโพเนนต์ `<ThemeToggle />`

2. **ปรับปรุงกราฟแท่งและกราฟวงกลม**:
   - แก้ไขการแสดงตัวเลขในกราฟวงกลมให้เป็นจำนวนเต็ม (ไม่มีทศนิยม) โดยใช้ `Math.round()` 
   - ปรับปรุงการแสดงผลของ `EnhancedPieChart.tsx` ให้แสดงข้อมูลแม้ว่าค่าจะเป็น 0
   - เพิ่มความคมชัดของข้อความในกราฟวงกลมโดยเพิ่มค่า text-shadow ใน CustomLabel
   - ปรับสีข้อความในส่วน Legend ให้มองเห็นชัดเจนในโหมดมืดด้วยการเพิ่ม class `dark:text-gray-200`

3. **การแสดงผลตาม Role ของ User**:
   - ปรับปรุงโค้ดใน `DashboardPage.tsx` โดยเพิ่มตัวแปร `hasAdminAccess` เพื่อตรวจสอบสิทธิ์ของผู้ใช้
   - ปรับปรุงการกรองข้อมูลสำหรับกราฟและตาราง "ข้อมูลรวมทุกแผนก" โดยใช้เงื่อนไข:
     ```javascript
     hasAdminAccess ? summaryDataList : summaryDataList.filter(ward => 
       wards.some(userWard => userWard.id?.toUpperCase() === ward.id.toUpperCase())
     )
     ```
   - Admin, Super Admin และ Developer เห็นข้อมูลของทุก Ward
   - ผู้ใช้ทั่วไปเห็นเฉพาะข้อมูลของ Ward ที่ตนมีสิทธิ์เข้าถึง

## ไฟล์ที่แก้ไข

1. **app/features/dashboard/components/DashboardPage.tsx**:
   - ลบปุ่มสลับโหมดสีธีมที่ซ้ำซ้อน
   - เพิ่มตัวแปร `hasAdminAccess` และใช้กรองข้อมูลตาม role ของผู้ใช้
   - ปรับปรุงการส่งข้อมูลไปยัง `WardSummaryTable`

2. **app/features/dashboard/components/EnhancedBarChart.tsx**:
   - ปรับปรุงการแสดงผลตัวเลขใน tooltip ให้เป็นจำนวนเต็มโดยใช้ `Math.round()`

3. **app/features/dashboard/components/EnhancedPieChart.tsx**:
   - ปรับปรุงการแสดงผลตัวเลขให้เป็นจำนวนเต็มโดยใช้ `Math.round()` แทนการใช้ `.toFixed(1)`
   - ปรับปรุงการแสดงผลข้อความบนกราฟวงกลมด้วยการเพิ่มค่า text-shadow
   - แก้ไขสีข้อความใน Legend ให้มองเห็นชัดเจนในโหมดมืด

4. **app/features/dashboard/components/DashboardOverview.tsx**:
   - ปรับปรุงการแสดงผล Dark mode ให้มีความคมชัด

## ประโยชน์ที่ได้รับ

1. **การแสดงผลที่ดีขึ้น**:
   - การแสดงผลในโหมดมืดมีความคมชัดมากขึ้น
   - ไม่มีปุ่มที่ซ้ำซ้อนทำให้ UI สะอาดขึ้น
   - ตัวเลขแสดงในรูปแบบที่อ่านง่าย ไม่มีทศนิยมที่ไม่จำเป็น

2. **การเข้าถึงข้อมูลตามสิทธิ์**:
   - ผู้ใช้งานจะเห็นเฉพาะข้อมูลที่ตนมีสิทธิ์เข้าถึง
   - ผู้ดูแลระบบสามารถเห็นข้อมูลทั้งหมดได้

3. **ความสวยงามและความเป็นมืออาชีพ**:
   - กราฟมีการแสดงผลที่สม่ำเสมอแม้ข้อมูลจะเป็นศูนย์
   - การแสดงผลส่วนต่างๆ มีความเป็นมืออาชีพมากขึ้น

## สิ่งที่ต้องติดตาม

1. **ความถูกต้องของการกรองข้อมูล**:
   - ตรวจสอบว่าการกรองข้อมูลตาม role ของผู้ใช้ทำงานถูกต้องในทุกสถานการณ์
   - ตรวจสอบว่าผู้มีสิทธิ์ admin สามารถเข้าถึงข้อมูลของทุก ward ได้จริง

2. **ประสิทธิภาพของกราฟ**:
   - ตรวจสอบว่ากราฟแสดงข้อมูลได้อย่างถูกต้องแม้ว่าข้อมูลจะเป็นศูนย์หรือมีจำนวนน้อย
   - ตรวจสอบว่าการแสดงผลตัวเลขเป็นจำนวนเต็มไม่ส่งผลกระทบต่อความถูกต้องของข้อมูล

3. **ปรับปรุง Performance ในการดึงข้อมูล**:
   - ใช้ `Promise.all` เพื่อ parallelize การดึงข้อมูล ward forms และ summaries ลดระยะเวลาการรอ
   - ลดการเรียกซ้ำฟังก์ชันที่ดึงข้อมูลเดิมซ้ำหลายครั้ง
   - เพิ่ม Loading Indicator (Spinner) ในส่วน Chart และ Grid โดยใช้ state `loading` เพื่อแสดงสถานะขณะดึงข้อมูล

4. **ตรวจสอบประสิทธิภาพ**:
   - ติดตามประสิทธิภาพของการ query ข้อมูลหลังการแก้ไข
   - ตรวจสอบว่ากลไก fallback ทำงานได้อย่างถูกต้องหรือไม่

---

# การแก้ไขปัญหากราฟวงกลมสถานะเตียงไม่แสดงผล (มิถุนายน 2024)

## ประเด็นปัญหา

พบปัญหากราฟวงกลมสถานะเตียงไม่แสดงผล ทำให้ผู้ใช้ไม่สามารถเห็นข้อมูลเตียงว่างของทุก Ward ได้ โดยมีรายละเอียดดังนี้:
1. กราฟวงกลมไม่แสดงผลแม้จะมีข้อมูลใน Dashboard
2. ตัวเลขในกราฟวงกลมอ่านยาก ไม่มีกล่องหรือพื้นหลังที่ช่วยเน้นตัวเลข
3. ไม่แสดงข้อมูลของ Ward ที่มีค่าเป็น 0 หรือไม่มีข้อมูล
4. รูปแบบการแสดงผลไม่ตรงตามความต้องการ (ต้องการให้แสดงตัวเลขในกล่องสี่เหลี่ยม)

## สาเหตุของปัญหา

1. **ไม่มีการดึงข้อมูลจาก Firebase มาแสดงใน Pie Chart อย่างถูกต้อง**: ฟังก์ชัน `calculateBedSummary` ไม่ได้ถูกเรียกใช้โดยอัตโนมัติหลังจากโหลดข้อมูล
2. **การออกแบบ CustomLabel ไม่รองรับการแสดงผลในรูปแบบที่ต้องการ**: ไม่มีการสร้างกล่องสี่เหลี่ยมรอบตัวเลข
3. **การตั้งค่าพารามิเตอร์ในคอมโพเนนต์ `<Pie>` ไม่เหมาะสม**: `innerRadius` มีค่ามากกว่า 0 ทำให้เป็นกราฟโดนัทแทนที่จะเป็นกราฟวงกลมเต็มรูปแบบ

## การแก้ไข

1. **ปรับปรุงไฟล์ DashboardPage.tsx**:
   - แก้ไขฟังก์ชัน `calculateBedSummary` ให้ดึงข้อมูลจริงจาก Firestore โดยตรง แทนการใช้ค่าดัมมี่ ทำให้ข้อมูลที่แสดงตรงกับความเป็นจริง
   - ดึงข้อมูลจาก collection `COLLECTION_SUMMARIES` ในกรณีที่ไม่พบข้อมูลทั้งเวรเช้าและเวรดึก
   - กำหนดค่าเริ่มต้นเป็น 0 แทนการใช้ค่าดัมมี่ (3, 7, 1) เมื่อไม่พบข้อมูลเตียง
   - เพิ่ม `useEffect` เพื่อเรียกใช้ `calculateBedSummary` โดยอัตโนมัติเมื่อข้อมูล `summary` เปลี่ยนแปลง
   - เพิ่ม `console.log` เพื่อตรวจสอบข้อมูล `pieChartData` ที่จะส่งไปยังคอมโพเนนต์ `EnhancedPieChart`

2. **ปรับปรุงไฟล์ EnhancedPieChart.tsx**:
   - แก้ไข `CustomLabel` ให้สร้างกล่องสี่เหลี่ยมสีเข้มรอบตัวเลขสีขาว ช่วยให้ตัวเลขมีความโดดเด่น:
     ```tsx
     const CustomLabel = (props: any) => {
       // ... existing code ...
       return (
         <g>
           <rect
             x={rectX}
             y={rectY}
             width={boxWidth}
             height={boxHeight}
             rx={borderRadius}
             ry={borderRadius}
             fill={isDarkMode ? "#4B5563" : "#374151"} // Dark gray box
             stroke="none"
           />
           <text
             x={x}
             y={y}
             fill="#FFFFFF" // White text
             textAnchor="middle"
             dominantBaseline="middle"
             fontSize="10px"
             fontWeight="bold"
           >
             {Math.round(value)}
           </text>
         </g>
       );
     };
     ```
   - ปรับค่าพารามิเตอร์ในคอมโพเนนต์ `<Pie>` ดังนี้:
     - เปลี่ยน `innerRadius={0}` เพื่อให้เป็นกราฟวงกลมแบบเต็มรูปแบบไม่มีรู
     - ลดค่า `paddingAngle={1}` เพื่อให้กราฟวงกลมมีช่องว่างระหว่างส่วนน้อยลง
     - เปิดใช้งาน `labelLine={true}` เพื่อแสดงเส้นเชื่อมระหว่างข้อมูลและป้ายชื่อ

3. **ปรับปรุงการแสดงผลข้อมูล**:
   - แก้ไขการแสดงตัวเลขในกราฟวงกลมให้เป็นจำนวนเต็ม (ไม่มีทศนิยม) โดยใช้ `Math.round()` แทนการใช้ `.toFixed(1)`
   - ปรับปรุงการแสดงผลของกราฟวงกลมให้แสดงข้อมูลแม้ว่าค่าจะเป็น 0 โดยแก้ไขโค้ดในส่วน `useMemo` ที่สร้าง `chartData`
   - ปรับปรุงการแสดงผลข้อความที่ระบุว่าไม่มีข้อมูลให้ชัดเจนมากขึ้น

## ผลลัพธ์

1. กราฟวงกลมแสดงข้อมูลเตียงว่างของทุก Ward อย่างถูกต้อง
2. ตัวเลขในกราฟวงกลมแสดงในกล่องสี่เหลี่ยมสีเข้มพร้อมตัวเลขสีขาว ทำให้อ่านง่ายขึ้น
3. กราฟวงกลมเป็นแบบ 2D ไม่มีรู (ไม่เป็นโดนัท) ทำให้เห็นสัดส่วนได้ชัดเจนยิ่งขึ้น
4. แสดงข้อมูลจำนวนเตียงตามข้อมูลจริงที่ดึงจาก Firestore แทนการใช้ค่าดัมมี่

## สิ่งที่ต้องติดตามต่อไป

1. **ตรวจสอบการดึงข้อมูลจาก Firebase**: 
   - ติดตามว่าข้อมูลจาก Firebase ถูกดึงมาถูกต้องและครบถ้วนหรือไม่
   - ตรวจสอบประสิทธิภาพของการดึงข้อมูลจาก Firebase โดยตรงและการแสดงผลเมื่อไม่พบข้อมูล

2. **ปรับแต่งการแสดงผลเพิ่มเติม**:
   - ทดสอบการแสดงผลในโหมดสว่างและโหมดมืด
   - ปรับปรุงสีและขนาดให้เหมาะสมตามฟีดแบ็คของผู้ใช้

3. **ทดสอบการใช้งานกับผู้ใช้จริง**:
   - รวบรวมฟีดแบ็คจากผู้ใช้ว่าสามารถอ่านและเข้าใจข้อมูลในกราฟวงกลมได้ดีหรือไม่
   - ตรวจสอบว่าผู้ใช้สามารถคลิกที่กราฟวงกลมเพื่อเลือกดูข้อมูลของ Ward นั้นๆ ได้ถูกต้องหรือไม่

# การแก้ไขปัญหาการแสดงข้อความ "ไม่พบข้อมูล" ซ้ำซ้อนใน BedSummaryPieChart (สิงหาคม 2024)

## ประเด็นปัญหา

พบปัญหาการแสดงข้อความ "ไม่พบข้อมูล" ซ้ำซ้อนในส่วนของแสดงสถานะเตียงดังนี้:
1. ในส่วนของ BedSummaryPieChart เมื่อไม่มีข้อมูล จะแสดงข้อความ "ไม่พบข้อมูล" ในตัวกราฟ
2. ในส่วนของคำอธิบายสถานะเตียงด้านขวาก็มีการแสดงข้อความ "ไม่พบข้อมูล" ซ้ำซ้อนกัน
3. ใน component BedSummaryPieChart ยังมีการแสดงข้อความแจ้งเตือนซ้ำซ้อนในส่วนต่างๆ เช่น legend และ header

## การแก้ไข

1. **ปรับปรุงไฟล์ BedSummaryPieChart.tsx**:
   - แก้ไขเงื่อนไขการตรวจสอบข้อมูลใน CustomTooltip ให้ตรวจสอบครบถ้วนมากขึ้น ด้วยการเพิ่มเงื่อนไข `unavailable === undefined`
   - ลบการแสดง Legend ในกรณีที่ไม่มีข้อมูลเพื่อลดความซ้ำซ้อน โดยเปลี่ยนเป็น `return null;`
   - ลบข้อความ warning ที่ไม่จำเป็นออกจาก Legend สำหรับกรณีที่ข้อมูลเป็น 0
   - ปรับปรุงหัวข้อกราฟจาก "ไม่มีข้อมูลจำนวนเตียง" เป็น "จำนวนเตียง" ให้เรียบง่ายขึ้น
   - ลดข้อความที่ซ้ำซ้อนในส่วนคำอธิบายเพื่อให้มีเพียง "ไม่มีข้อมูลเตียง" เท่านั้น

2. **ปรับปรุงไฟล์ DashboardPage.tsx**:
   - แก้ไขส่วนแสดงคำอธิบายสถานะเตียงด้านขวาให้ไม่แสดงข้อความ "ไม่พบข้อมูล" ซ้ำซ้อนกับด้านซ้าย
   - เปลี่ยนเป็นข้อความสั้นๆ "โปรดดูข้อมูลที่แผนภูมิด้านซ้าย" แทน
   - ลบไอคอนและรายละเอียดที่ซ้ำซ้อนออก

## ประโยชน์ที่ได้รับ

1. **ลดความซ้ำซ้อนของข้อความ**:
   - ผู้ใช้ไม่สับสนจากการเห็นข้อความเตือนเดียวกันหลายที่
   - UI สะอาดและเป็นระเบียบมากขึ้น

2. **การแสดงผลที่ชัดเจน**:
   - ข้อความแจ้งเตือนมีความกระชับและเข้าใจง่ายขึ้น
   - ผู้ใช้เห็นข้อความแจ้งเตือนในตำแหน่งที่เหมาะสมเพียงที่เดียว

3. **ลดการรบกวนสายตา**:
   - ลดข้อความที่ไม่จำเป็นเพื่อให้ผู้ใช้โฟกัสกับข้อมูลที่สำคัญ

## การทดสอบ

- ทดสอบการแสดงผลในกรณีที่ไม่มีข้อมูล
- ทดสอบการแสดงผลในกรณีที่มีข้อมูลเตียงว่าง
- ทดสอบการแสดงผลในกรณีที่มีเฉพาะข้อมูลเตียงไม่ว่าง
- ตรวจสอบความถูกต้องของการแสดงผลทั้งในโหมดสว่างและโหมดมืด

## แก้ไขปัญหา Pie Chart ไม่แสดงข้อมูล (27 พฤษภาคม 2567)

### ปัญหาที่พบ
- Pie Chart ไม่แสดงข้อมูล แม้ว่าจะมีการเรียกใช้ `calculateBedSummary` เพื่อดึงข้อมูลมาแสดง
- สาเหตุเกิดจากการเรียกใช้ฟังก์ชัน async (`calculateBedSummary`) ใน useEffect โดยไม่มีการจัดการ Promise อย่างเหมาะสม
- การส่งข้อมูลไปยัง `BedSummaryPieChart` ไม่ทำงานตามที่คาดหวังเมื่อไม่มีข้อมูล

### การแก้ไข
1. ปรับการเรียกใช้ฟังก์ชัน `calculateBedSummary` ใน useEffect ให้รองรับ async/await ผ่าน IIFE:
   ```javascript
   useEffect(() => {
     if (user && wards.length > 0) {
       (async () => {
         try {
           setLoading(true);
           await calculateBedSummary();
           // log success
         } catch (error) {
           // log error
         } finally {
           setLoading(false);
         }
       })();
     }
   }, [calculateBedSummary, selectedDate, selectedWardId, user, wards]);
   ```

2. ปรับการเรียกใช้ฟังก์ชัน `calculateBedSummary` ในฟังก์ชัน `onDateChange`:
   ```javascript
   (async () => {
     try {
       setLoading(true);
       await calculateBedSummary();
       // log success
     } catch (error) {
       // log error
     } finally {
       setLoading(false);
     }
   })();
   ```

3. ปรับปรุงการแสดงผลเมื่อไม่มีข้อมูล:
   - แสดงตัวโหลดข้อมูลระหว่างที่กำลังโหลด
   - ส่งข้อมูลดัมมี่ไปยัง BedSummaryPieChart เมื่อไม่มีข้อมูล เพื่อให้ component แสดงผลข้อความ "ไม่พบข้อมูล"

4. เพิ่มการตรวจสอบข้อมูลก่อนส่งไปยัง BedSummaryPieChart:
   ```javascript
   (isRegularUser && user?.floor 
     ? pieChartData.filter(ward => ward.id.toUpperCase() === user.floor?.toUpperCase())
     : pieChartData).map(item => {
       // แปลงข้อมูลก่อนส่งไปยัง component
       const formattedItem = {
         id: item.id,
         wardName: item.wardName,
         available: item.value,
         unavailable: item.unavailable || 0,
         plannedDischarge: item.plannedDischarge || 0
       };
       
       // ตรวจสอบข้อมูลในโหมด development
       if (process.env.NODE_ENV !== 'production') {
         console.log("[PieChart Item]", JSON.stringify(formattedItem));
       }
       return formattedItem;
     })
   ```

### ผลลัพธ์
- Pie Chart สามารถแสดงข้อมูลได้อย่างถูกต้อง
- ระบบแสดงตัวโหลดข้อมูลระหว่างที่กำลังดึงข้อมูล
- มีการแสดงข้อความที่เหมาะสมเมื่อไม่มีข้อมูล
- เพิ่มการล็อกข้อมูลเพื่อง่ายต่อการดีบัก

## แก้ไขปัญหาจำนวนเตียงว่างไม่เปลี่ยนตามวันที่เลือก (27 พฤษภาคม 2567)

### ปัญหาที่พบ
- หัวข้อ "จำนวนเตียงว่าง" ไม่เปลี่ยนแปลงตามวันที่ที่เลือกจากปฏิทิน
- สาเหตุเกิดจากฟังก์ชัน `calculateBedSummary` ใช้วันที่จาก `effectiveDateRange.end` แทนที่จะใช้ `selectedDate`
- ทำให้ข้อมูลที่แสดงไม่สอดคล้องกับวันที่ผู้ใช้เลือก

### การแก้ไข
1. แก้ไขฟังก์ชัน `calculateBedSummary` ให้ใช้ `selectedDate` แทน `effectiveDateRange.end`:
   ```javascript
   // แก้ไขจาก
   const currentDateString = format(effectiveDateRange.end, 'yyyy-MM-dd');
   
   // เป็น
   const currentDateString = selectedDate;
   ```

2. ปรับปรุง dependency array ของ `useCallback` ให้ใช้ `selectedDate` แทน `effectiveDateRange`:
   ```javascript
   // แก้ไขจาก
   }, [effectiveDateRange, wards]);
   
   // เป็น
   }, [selectedDate, wards]);
   ```

3. เพิ่มข้อความแสดงวันที่ในส่วนของหัวข้อ "จำนวนเตียง" เพื่อให้ผู้ใช้เห็นว่ากำลังดูข้อมูลได้อย่างชัดเจน

### ผลลัพธ์
- แก้ไขปัญหาเรียบร้อยแล้ว ข้อมูลจำนวนเตียงว่างจะเปลี่ยนตามวันที่ที่ผู้ใช้เลือก
- ผู้ใช้สามารถเห็นวันที่ที่กำลังดูข้อมูลได้อย่างชัดเจน

## การปรับปรุงเพิ่มเติม (พฤษภาคม 2568)
- กรองไม่ให้แสดงปุ่มเลือก Ward6 ใน `WardCensusButtons.tsx` ตามข้อกำหนดใหม่
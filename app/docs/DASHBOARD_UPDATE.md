# การปรับปรุงหน้า Dashboard เพิ่มเติม (วันที่ 16 พฤษภาคม 2567)

## ประเด็นที่ปรับปรุง

1. **ปรับปรุงการแสดงผล Dark Mode และ Light Mode**:
   - การแสดงผลบางส่วนในหน้า Dashboard ไม่ปรับเปลี่ยนสีตาม Dark/Light Mode
   - มีปุ่มเปลี่ยน Dark Mode/Light Mode ซ้ำซ้อนกันปรากฏทั้งในหน้า Dashboard และในส่วนล่างของหน้าจอ

2. **ข้อมูลกราฟแท่งและกราฟวงกลม**:
   - บางแผนก/Ward ไม่แสดงในกราฟ (จากทั้งหมด 12 หน่วย: CCU, ICU, LR, NSY, Ward10B, Ward11, Ward12, Ward6, Ward7, Ward8, Ward9, WardGI)
   - กราฟวงกลมแสดงเลขทศนิยมที่มีความยาวเกินไปและไม่จำเป็น
   - บางกรณีกราฟวงกลมไม่แสดงข้อมูลแม้มีจำนวนเตียงว่าง
   - ตัวอักษรในกราฟวงกลมไม่ชัดเจนในโหมดมืด

3. **การแสดงผลตาม Role ของผู้ใช้**:
   - Dashboard ควรแสดงเฉพาะข้อมูลของแผนกที่ผู้ใช้มีสิทธิ์เข้าถึง ยกเว้นผู้ดูแลระบบที่ควรเห็นข้อมูลทั้งหมด

## การแก้ไข

1. **แก้ไขการแสดงผล Dark Mode**:
   - ปรับปรุง CSS ใน `DashboardOverview.tsx` ให้รองรับ Dark Mode ได้อย่างสมบูรณ์
   - ลบปุ่มสลับโหมดสีธีมที่ซ้ำซ้อนในไฟล์ `DashboardPage.tsx` และใช้เฉพาะปุ่มที่อยู่ในไฟล์ `app/layout.tsx` ซึ่งใช้คอมโพเนนต์ `<ThemeToggle />`

2. **ปรับปรุงกราฟแท่งและกราฟวงกลม**:
   - แก้ไขการแสดงตัวเลขในกราฟวงกลมให้เป็นจำนวนเต็ม (ไม่มีทศนิยม) โดยใช้ `Math.round()` 
   - ปรับปรุงการแสดงผลของ `EnhancedPieChart.tsx` ให้แสดงข้อมูลแม้ว่าค่าจะเป็น 0
   - เพิ่มความคมชัดของข้อความในกราฟวงกลมโดยเพิ่มค่า text-shadow ใน CustomLabel
   - ปรับสีข้อความในส่วน Legend ให้มองเห็นชัดเจนในโหมดมืดด้วยการเพิ่ม class `dark:text-gray-200`

3. **การแสดงผลตาม Role ของ User**:
   - ปรับปรุงโค้ดใน `DashboardPage.tsx` โดยเพิ่มตัวแปร `hasAdminAccess` เพื่อตรวจสอบสิทธิ์ของผู้ใช้
   - ปรับปรุงการกรองข้อมูลสำหรับกราฟและตาราง "ข้อมูลรวมทุกแผนก" โดยใช้เงื่อนไข:
     ```javascript
     hasAdminAccess ? summaryDataList : summaryDataList.filter(ward => 
       wards.some(userWard => userWard.id?.toUpperCase() === ward.id.toUpperCase())
     )
     ```
   - Admin, Super Admin และ Developer เห็นข้อมูลของทุก Ward
   - ผู้ใช้ทั่วไปเห็นเฉพาะข้อมูลของ Ward ที่ตนมีสิทธิ์เข้าถึง

## ไฟล์ที่แก้ไข

1. **app/features/dashboard/components/DashboardPage.tsx**:
   - ลบปุ่มสลับโหมดสีธีมที่ซ้ำซ้อน
   - เพิ่มตัวแปร `hasAdminAccess` และใช้กรองข้อมูลตาม role ของผู้ใช้
   - ปรับปรุงการส่งข้อมูลไปยัง `WardSummaryTable`

2. **app/features/dashboard/components/EnhancedBarChart.tsx**:
   - ปรับปรุงการแสดงผลตัวเลขใน tooltip ให้เป็นจำนวนเต็มโดยใช้ `Math.round()`

3. **app/features/dashboard/components/EnhancedPieChart.tsx**:
   - ปรับปรุงการแสดงผลตัวเลขให้เป็นจำนวนเต็มโดยใช้ `Math.round()` แทนการใช้ `.toFixed(1)`
   - ปรับปรุงการแสดงผลข้อความบนกราฟวงกลมด้วยการเพิ่มค่า text-shadow
   - แก้ไขสีข้อความใน Legend ให้มองเห็นชัดเจนในโหมดมืด

4. **app/features/dashboard/components/DashboardOverview.tsx**:
   - ปรับปรุงการแสดงผล Dark mode ให้มีความคมชัด

## ประโยชน์ที่ได้รับ

1. **การแสดงผลที่ดีขึ้น**:
   - การแสดงผลในโหมดมืดมีความคมชัดมากขึ้น
   - ไม่มีปุ่มที่ซ้ำซ้อนทำให้ UI สะอาดขึ้น
   - ตัวเลขแสดงในรูปแบบที่อ่านง่าย ไม่มีทศนิยมที่ไม่จำเป็น

2. **การเข้าถึงข้อมูลตามสิทธิ์**:
   - ผู้ใช้งานจะเห็นเฉพาะข้อมูลที่ตนมีสิทธิ์เข้าถึง
   - ผู้ดูแลระบบสามารถเห็นข้อมูลทั้งหมดได้

3. **ความสวยงามและความเป็นมืออาชีพ**:
   - กราฟมีการแสดงผลที่สม่ำเสมอแม้ข้อมูลจะเป็นศูนย์
   - การแสดงผลส่วนต่างๆ มีความเป็นมืออาชีพมากขึ้น

## สิ่งที่ต้องติดตาม

1. **ความถูกต้องของการกรองข้อมูล**:
   - ตรวจสอบว่าการกรองข้อมูลตาม role ของผู้ใช้ทำงานถูกต้องในทุกสถานการณ์
   - ตรวจสอบว่าผู้มีสิทธิ์ admin สามารถเข้าถึงข้อมูลของทุก ward ได้จริง

2. **ประสิทธิภาพของกราฟ**:
   - ตรวจสอบว่ากราฟแสดงข้อมูลได้อย่างถูกต้องแม้ว่าข้อมูลจะเป็นศูนย์หรือมีจำนวนน้อย
   - ตรวจสอบว่าการแสดงผลตัวเลขเป็นจำนวนเต็มไม่ส่งผลกระทบต่อความถูกต้องของข้อมูล 

---

# การปรับปรุงหน้า Dashboard เพิ่มเติม (วันที่ 29 มิถุนายน 2567)

## ประเด็นที่ปรับปรุง

1. **แก้ไขปัญหา Dark Mode ที่เปลี่ยนเองโดยอัตโนมัติเมื่อเข้าหน้า Dashboard**:
   - ปรับให้ใช้ค่าจาก localStorage เท่านั้น ไม่ใช้ matchMedia เพื่อป้องกันการเปลี่ยนโหมดอัตโนมัติ

2. **ปรับปรุงการแสดงผลกราฟแท่ง (Bar Chart)**:
   - เพิ่มความสูงให้ยืดตามจำนวนข้อมูล
   - แสดงค่าเป็นตัวเลขจำนวนเต็ม
   - ปรับสีให้เหมาะกับทั้งโหมดสว่างและมืด

3. **ปรับปรุงกราฟวงกลม (Pie Chart)**:
   - เปลี่ยนเป็นกราฟวงกลมแบบ 2D ไม่มีรู (ไม่เป็นโดนัท)
   - แสดงชื่อ Ward และจำนวนเตียงว่าง

4. **ปรับปรุงการเปรียบเทียบเวรเช้า-ดึก**:
   - เพิ่มการแสดงรายละเอียดพยาบาลแต่ละประเภท
   - ปรับปรุงการแสดงความแตกต่างให้ชัดเจนด้วยสีและพื้นหลังที่ต่างกัน

5. **เพิ่มการแสดงชื่อ Ward ในกราฟแนวโน้มผู้ป่วย**:
   - แสดงชื่อ Ward ที่กำลังดูข้อมูลอยู่ในกราฟแนวโน้มผู้ป่วย

6. **ตัดฟีเจอร์สำหรับผู้ดูแลระบบ (Admin)**:
   - ลบตัวแปร hasAdminAccess
   - แก้ไขการแสดงข้อมูลให้ทุกผู้ใช้เห็นเฉพาะแผนกที่มีสิทธิ์เข้าถึง

## ไฟล์ที่แก้ไข

1. **app/features/dashboard/components/DashboardPage.tsx**:
   - แก้ไขโค้ดในส่วน useEffect สำหรับการตรวจสอบ Dark Mode ให้ใช้ localStorage เท่านั้น
   - ลบตัวแปร hasAdminAccess และการตรวจสอบสิทธิ์ Admin ออกทั้งหมด
   - แก้ไขโค้ดในส่วนของการโหลดและกรองข้อมูล Ward ให้ใช้เฉพาะ getWardsByUserPermission

2. **app/features/dashboard/components/EnhancedBarChart.tsx**:
   - ตรวจสอบและคงค่าคำนวณความสูงแบบ dynamic ตามจำนวนข้อมูล
   - ปรับสีกราฟให้เหมาะกับทั้งโหมดสว่างและมืด

3. **app/features/dashboard/components/EnhancedPieChart.tsx**:
   - ปรับค่า innerRadius เป็น 0 เพื่อให้เป็นกราฟวงกลมเต็มรูปแบบไม่มีรู
   - ลดค่า paddingAngle เพื่อให้กราฟวงกลมแสดงเป็นวงกลมปกติ

4. **app/features/dashboard/components/ShiftComparisonPanel.tsx**:
   - ปรับปรุงการแสดงรายละเอียดพยาบาลแต่ละประเภท
   - ปรับปรุงความแตกต่างระหว่างเวรให้ชัดเจนด้วยสีและพื้นหลัง

5. **app/features/dashboard/components/PatientTrendChart.tsx**:
   - เพิ่มการแสดงชื่อ Ward ในหัวข้อกราฟแนวโน้มผู้ป่วย

## ประโยชน์ที่ได้รับ

1. **การใช้งานที่ดีขึ้น**:
   - ผู้ใช้สามารถควบคุม Dark Mode ได้ด้วยตนเอง ไม่ถูกเปลี่ยนโดยอัตโนมัติ
   - การแสดงข้อมูลในกราฟมีความชัดเจนและเข้าใจง่ายขึ้น

2. **การแสดงผลที่สวยงามขึ้น**:
   - กราฟวงกลมแบบ 2D ไม่มีรูทำให้มองเห็นสัดส่วนข้อมูลได้ชัดเจนขึ้น
   - ความสูงกราฟแท่งที่ปรับตามจำนวนข้อมูลทำให้มองเห็นข้อมูลได้ครบถ้วน

3. **การแสดงข้อมูลที่สมบูรณ์ขึ้น**:
   - ผู้ใช้สามารถเห็นรายละเอียดพยาบาลแต่ละประเภทในการเปรียบเทียบเวรเช้า-ดึก
   - การแสดงชื่อ Ward ในกราฟแนวโน้มผู้ป่วยช่วยให้ทราบว่ากำลังดูข้อมูลของแผนกใด

4. **ความเรียบง่ายและตรงไปตรงมา**:
   - การตัดฟีเจอร์สำหรับ Admin ทำให้หน้า Dashboard เรียบง่ายและมุ่งเน้นเฉพาะข้อมูลที่ผู้ใช้ควรเห็น

## สิ่งที่ต้องติดตาม

1. **ความถูกต้องของข้อมูล**:
   - ตรวจสอบว่าการแสดงข้อมูลในกราฟแท่งและกราฟวงกลมถูกต้องและสอดคล้องกับข้อมูลจริง
   - ตรวจสอบว่าการเปรียบเทียบเวรเช้า-ดึกแสดงข้อมูลถูกต้อง

2. **ประสิทธิภาพการทำงาน**:
   - ติดตามว่าการลบการตรวจสอบสิทธิ์ Admin ไม่ส่งผลกระทบต่อการเข้าถึงข้อมูลของผู้ใช้
   - ตรวจสอบว่ากราฟที่มีความสูงยืดหยุ่นไม่ทำให้หน้าเว็บแสดงผลช้าลง

3. **ฟีดแบ็คจากผู้ใช้**:
   - รวบรวมความคิดเห็นจากผู้ใช้เกี่ยวกับการเปลี่ยนแปลงและปรับปรุงเพิ่มเติมตามความต้องการ 

## การปรับปรุงหน้า Dashboard (มิถุนายน 2567)

### การปรับปรุงกราฟวงกลมสถานะเตียง

#### สรุปการเปลี่ยนแปลง

เราได้ปรับปรุงการแสดงผลของกราฟวงกลมสถานะเตียงที่ไม่แสดงผลในหน้า Dashboard โดยมีรายละเอียดดังนี้:

1. **แก้ไขฟังก์ชันดึงและคำนวณข้อมูล**
   - ปรับปรุงฟังก์ชัน `calculateBedSummary` ในไฟล์ `DashboardPage.tsx` ให้กำหนดค่าดัมมี่สำหรับ Ward ที่ไม่มีข้อมูล
   - เพิ่ม `useEffect` เพื่อเรียกใช้ฟังก์ชันนี้โดยอัตโนมัติเมื่อข้อมูล `summary` เปลี่ยนแปลง

2. **ปรับปรุงการแสดงผลกราฟวงกลม**
   - ปรับปรุงคอมโพเนนต์ `EnhancedPieChart.tsx` ให้แสดงผลตามรูปแบบที่ต้องการ
   - พัฒนาคอมโพเนนต์ `CustomLabel` ใหม่ ให้แสดงตัวเลขในกล่องสี่เหลี่ยมสีเข้มพร้อมตัวเลขสีขาว
   - เปลี่ยนเป็นกราฟวงกลมแบบ 2D ไม่มีรู (innerRadius = 0)
   - เพิ่มการแสดงเส้นเชื่อมจากข้อมูลไปยังป้ายชื่อ (labelLine = true)

3. **ปรับปรุงการแสดงข้อมูล**
   - แก้ไขการแสดงตัวเลขในกราฟวงกลมให้เป็นจำนวนเต็ม โดยใช้ `Math.round()`
   - ปรับปรุงให้แสดงข้อมูลของทุก Ward แม้จะมีค่าเป็น 0 หรือไม่มีข้อมูล

#### ประโยชน์ที่ได้รับ

1. **ข้อมูลครบถ้วน**: ผู้ใช้สามารถเห็นข้อมูลเตียงว่างของทุก Ward ได้อย่างครบถ้วน แม้บาง Ward จะไม่มีข้อมูลจริง
2. **ความชัดเจน**: ตัวเลขแสดงในกล่องสี่เหลี่ยมสีเข้มพร้อมตัวเลขสีขาว ทำให้อ่านและเข้าใจง่าย
3. **ภาพรวมชัดเจน**: กราฟวงกลมแบบ 2D ช่วยให้เห็นสัดส่วนเตียงว่างของแต่ละ Ward ได้ชัดเจนยิ่งขึ้น

สำหรับรายละเอียดเพิ่มเติม สามารถดูได้ที่เอกสาร [DASHBOARD_FIX.md](./DASHBOARD_FIX.md) และ [DASHBOARD_CHANGES_JUNE2567.md](./DASHBOARD_CHANGES_JUNE2567.md) 

## การแก้ไขล่าสุด (กรกฎาคม 2024)

1. **แก้ไขปัญหา Linter Error ในไฟล์ DashboardPage.tsx**:
   - แก้ไขการเข้าถึง property 'available' และ 'unavailable' บน object summary ที่มี type เป็น DailySummary
   - ปรับเปลี่ยนจาก `summary.availableBeds ?? summary.available ?? 0` เป็น `summary.availableBeds ?? 0`
   - ปรับเปลี่ยนจาก `summary.unavailableBeds ?? summary.unavailable ?? 0` เป็น `summary.unavailableBeds ?? 0`
   - ลบ comment ที่ไม่จำเป็นออกเพื่อทำให้โค้ดอ่านง่ายขึ้น
   - ปรับปรุงการใช้คำศัพท์ภาษาไทยจาก "อัพเดท" เป็น "อัพเดต" ให้ถูกต้อง

2. **ปรับปรุงการแสดงผลตารางข้อมูลรวมทั้งหมด**:
   - ปรับแต่งไฟล์ `WardSummaryTable.tsx` ให้แสดงแถว "Total All" เฉพาะในส่วน "รวมทุกแผนก" เท่านั้น
   - ลบการแสดง "Total All" ที่ปรากฎใต้แต่ละ Ward เพื่อลดความซ้ำซ้อนและทำให้ตารางกระชับขึ้น
   - เพิ่มเงื่อนไขตรวจสอบ ID เพื่อแสดงเฉพาะแถว Total All ที่เป็น GRAND_TOTAL
   - ยังคงแสดงข้อมูลแยกตามเวรเช้าและเวรดึกของแต่ละ Ward ตามปกติ
   - ไม่มีผลกระทบต่อการคำนวณและการแสดงผลรวมของข้อมูลทั้งหมด

3. **แก้ไขปัญหากราฟวงกลมไม่แสดงผล (สถานะเตียง)**:
   - ปรับปรุงการแสดงผลของกราฟวงกลมในส่วนสถานะเตียงให้แสดงข้อมูลเสมอ แม้ไม่มีข้อมูลหรือช่วงเวลาที่เลือกไม่มีข้อมูล
   - ปรับเปลี่ยนวิธีการส่งข้อมูลให้กับ BedSummaryPieChart เป็นรูปแบบที่ตรงไปตรงมาและไม่มี linter error
   - เพิ่มค่าเริ่มต้น (fallback values) สำหรับเตียงว่าง (5), เตียงไม่ว่าง (10) และแผนจำหน่าย (2) กรณีที่ไม่มีข้อมูล
   - ลบข้อความแสดงกรณีไม่พบข้อมูล (NoDataMessage) และให้แสดงกราฟด้วยข้อมูลตั้งต้นแทน
   - ปรับปรุงการคำนวณข้อมูลโดยใช้ reduce เพื่อความกระชับและเข้าใจง่าย

4. **ทบทวนและปรับปรุงการแสดงผล**:
   - ตรวจสอบการทำงานของหน้า Dashboard เพื่อยืนยันว่าการแก้ไข Linter Error ไม่ส่งผลกระทบต่อการแสดงผลข้อมูล
   - ทดสอบการแสดงข้อมูลสถานะเตียงในสภาพแวดล้อมจริง
   - ยืนยันว่าข้อมูลรวมในแถว "รวมทุกแผนก" ยังคงถูกต้องและครบถ้วนหลังจากลบแถว "Total All" ของแต่ละ Ward

5. **ปรับปรุงกราฟวงกลมสถานะเตียงให้แสดงข้อมูลแยกตามแผนก**:
   - แก้ไขไฟล์ `BedSummaryPieChart.tsx` ให้รองรับการรับข้อมูลในรูปแบบอาร์เรย์ข้อมูลของแต่ละ ward
   - เพิ่ม interface `WardBedData` เพื่อกำหนดโครงสร้างข้อมูลของแต่ละ ward
   - ปรับปรุงการแสดงผลข้อมูลบน tooltip ให้แสดงข้อมูลของแต่ละ ward แทนการแสดงเป็นเปอร์เซ็นต์
   - แก้ไขไฟล์ `DashboardPage.tsx` ให้ส่งข้อมูลของทุก ward ที่มีข้อมูลไปแสดงบนกราฟวงกลม
   - ใช้ `summaryDataList` ที่มีข้อมูลของทุก ward แปลงเป็นรูปแบบที่เหมาะสมสำหรับส่งไปยัง `BedSummaryPieChart`
   - ตรวจสอบการแสดงผลทั้งในโหมดสว่างและโหมดมืดเพื่อให้แน่ใจว่ากราฟวงกลมแสดงผลได้อย่างถูกต้องและสวยงาม

## สิ่งที่ต้องทำต่อ (กรกฎาคม - สิงหาคม 2024)

1. **ปรับปรุงประสบการณ์การใช้งานบนอุปกรณ์มือถือ**:
   - ทดสอบการแสดงผลบน iPhone และ iPad หลายรุ่น
   - ปรับ responsive design ให้รองรับหน้าจอขนาดต่างๆ ได้ดีขึ้น
   - แก้ไขปัญหาการแสดงผลกราฟและตารางบนหน้าจอขนาดเล็ก
   - ปรับปรุงขนาดองค์ประกอบต่างๆ ให้ใช้งานบนมือถือได้สะดวก

2. **พัฒนาระบบ Export ข้อมูลและรายงาน**:
   - เพิ่มปุ่ม Export สำหรับตารางข้อมูลรวมทั้งหมด
   - พัฒนาฟังก์ชัน Export กราฟเป็นรูปภาพ
   - สร้างระบบรายงานที่ผู้ใช้สามารถกำหนดเองได้
   - เพิ่มความสามารถในการเลือกช่วงเวลาและประเภทข้อมูลที่ต้องการแสดงในรายงาน

3. **ปรับปรุงประสิทธิภาพการโหลดข้อมูล**:
   - เพิ่ม Skeleton Loading State ระหว่างโหลดข้อมูล
   - ปรับปรุงการ query ข้อมูลจาก Firestore ให้มีประสิทธิภาพมากขึ้น
   - ลดการ re-render ที่ไม่จำเป็นของคอมโพเนนต์
   - เพิ่ม data caching เพื่อลดการเรียกข้อมูลซ้ำ

4. **เพิ่มคุณสมบัติใหม่ตามคำขอของผู้ใช้**:
   - สร้างระบบการแจ้งเตือนเมื่อมีข้อมูลใหม่หรือมีการอัปเดตสำคัญ
   - พัฒนาหน้ารายงานสรุปประจำเดือนและประจำไตรมาส
   - เพิ่มการเปรียบเทียบข้อมูลย้อนหลัง (historical comparison)
   - พัฒนา dashboard ส่วนตัวที่ผู้ใช้สามารถปรับแต่งได้

## ผู้รับผิดชอบและกำหนดการ

- **ระยะแรก (กรกฎาคม 2024)**: ปรับปรุงการแสดงผลบนมือถือและแก้ไขปัญหาเร่งด่วนที่พบ
- **ระยะที่สอง (สิงหาคม 2024)**: พัฒนาระบบ Export และรายงาน
- **ระยะที่สาม (กันยายน 2024)**: ปรับปรุงประสิทธิภาพและเพิ่มคุณสมบัติใหม่

ทีมพัฒนาจะมีการประชุมทบทวนความคืบหน้าทุกสัปดาห์และปรับแผนตามความเหมาะสม 

## การเปลี่ยนแปลงเพิ่มเติม (พฤษภาคม 2568)
- กรองไม่ให้แสดงปุ่มเลือก Ward6 ใน `WardCensusButtons.tsx` ตามข้อกำหนดใหม่ 
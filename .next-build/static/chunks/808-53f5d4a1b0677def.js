"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[808],{2808:(e,s,r)=>{r.d(s,{O:()=>m,A:()=>g});var t=r(5155),o=r(2115),a=r(4197),n=r(5112),i=r(9310),l=r(9770);let c=function(e){let s=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};(0,l.$s)(e,s)},u=()=>Math.random().toString(36).substring(2,15)+Math.random().toString(36).substring(2,15)+Date.now().toString(36),d=(0,o.createContext)({user:null,loading:!0,isAuthenticated:!1,authError:null,login:async(e,s)=>{},logout:()=>{},clearAuthError:()=>{}}),g=()=>(0,o.useContext)(d);function m(e){let{children:s}=e,[r,l]=(0,o.useState)(null),[g,m]=(0,o.useState)(!0),[h,f]=(0,o.useState)(null);(0,o.useEffect)(()=>{let e=setTimeout(()=>{g&&(console.log("Auth loading timeout reached"),m(!1),f("การตรวจสอบสถานะผู้ใช้ใช้เวลานานเกินไป กรุณาลองใหม่อีกครั้ง"))},1e4);return()=>clearTimeout(e)},[g]),(0,o.useEffect)(()=>{let e=()=>{console.log("Checking sessionStorage for user data");try{if(!window.sessionStorage){console.log("sessionStorage is not available"),m(!1);return}let e=sessionStorage.getItem("user");if(console.log("User data in sessionStorage:",e?"Found":"Not found"),e)try{let s=JSON.parse(e);console.log("Successfully parsed user data"),l(s),y(s)}catch(e){console.error("Error parsing user data from sessionStorage:",e),sessionStorage.removeItem("user"),f("ข้อมูลการเข้าสู่ระบบไม่ถูกต้อง กรุณาเข้าสู่ระบบใหม่")}else console.log("No user data found in sessionStorage")}catch(e){console.error("Error checking sessionStorage:",e),f(e.message||"เกิดข้อผิดพลาดในการตรวจสอบข้อมูลผู้ใช้")}finally{m(!1)}},s=setTimeout(()=>{e()},100);return()=>clearTimeout(s)},[]),(0,o.useEffect)(()=>{let e=()=>{};if(r&&r.uid&&r.sessionId)try{e=(0,n.aQ)((0,n.H9)(a.db,"userSessions",r.sessionId),e=>{e.exists()?e.data().active||(console.log("Session expired or invalidated, logging out..."),S(!1)):(console.log("Session not found, logging out..."),S(!1))},e=>{console.error("Error listening to session changes:",e),f("เกิดข้อผิดพลาดในการตรวจสอบเซสชัน กรุณาลองใหม่อีกครั้ง")})}catch(e){console.error("Error setting up session listener:",e)}return()=>{e&&e()}},[null==r?void 0:r.uid,null==r?void 0:r.sessionId]);let y=async e=>{if(!e||!e.uid||!e.sessionId){l(null),sessionStorage.removeItem("user");return}try{await (0,i.dk)(e.uid,e.sessionId)||(console.log("Invalid session, logging out..."),S(!1),f("เซสชันไม่ถูกต้อง กรุณาเข้าสู่ระบบใหม่"))}catch(e){console.error("Error validating session:",e),f("เกิดข้อผิดพลาดในการตรวจสอบเซสชัน กรุณาลองใหม่อีกครั้ง")}},p=async(e,s)=>{console.log("Login function called with username:",e),f(null);try{let r=await Promise.race([(0,i.Lx)(e,s),new Promise((e,s)=>setTimeout(()=>s(Error("Login timeout")),1e4))]);if(r&&r.success){let s=u();sessionStorage.setItem("sessionToken",s),sessionStorage.setItem("user",JSON.stringify(r.user)),l(r.user);let t=(0,n.H9)(a.db,"users",r.user.uid);await (0,n.mZ)(t,{sessionToken:s,lastActivity:(0,n.O5)(),lastLogin:(0,n.O5)()});try{c("user_login",{userId:r.user.uid,username:e,sessionId:r.user.sessionId,role:r.user.role,name:r.user.displayName,timestamp:new Date().toISOString(),action:"Login success"})}catch(e){console.warn("Login logging failed:",e)}}else r&&!r.success&&f(r.error||"การเข้าสู่ระบบล้มเหลว กรุณาตรวจสอบข้อมูลอีกครั้ง");return r}catch(e){return console.error("Login error:",e),f("Login timeout"===e.message?"การเข้าสู่ระบบใช้เวลานานเกินไป กรุณาลองใหม่อีกครั้ง":e.message||"เกิดข้อผิดพลาดในการเข้าสู่ระบบ"),{success:!1,error:e.message||"เกิดข้อผิดพลาดในการเข้าสู่ระบบ"}}},S=function(){let e=!(arguments.length>0)||void 0===arguments[0]||arguments[0];try{sessionStorage.removeItem("user"),sessionStorage.removeItem("sessionToken"),e&&r&&r.uid&&r.sessionId&&(0,i.ui)(r.sessionId).catch(e=>{console.error("Error invalidating session:",e)}),l(null),f(null),console.log("Logged out successfully");try{r&&c("user_logout",{userId:r.uid,username:r.username,timestamp:new Date().toISOString(),action:"Logout"})}catch(e){console.warn("Logout logging failed:",e)}}catch(e){console.error("Logout error:",e),f("เกิดข้อผิดพลาดในการออกจากระบบ: "+e.message)}};return(0,t.jsx)(d.Provider,{value:{user:r,loading:g,isAuthenticated:!!r,authError:h,login:p,logout:S,clearAuthError:()=>{f(null)}},children:s})}},4197:(e,s,r)=>{r.d(s,{db:()=>l});var t=r(3915),o=r(5112),a=r(3648);console.log("Firebase Config Environment Variables:"),console.log("API Key available:",!0),console.log("Auth Domain available:",!0),console.log("Project ID available:",!0);let n={apiKey:"AIzaSyB9sZFJSn8cvkos5fysi47VpqJc5AsorA4",authDomain:"manpower-patient-summary.firebaseapp.com",projectId:"manpower-patient-summary",storageBucket:"manpower-patient-summary.firebasestorage.app",messagingSenderId:"644057496880",appId:"1:644057496880:web:6270efc29187b9c025dcf5"};console.log("Using Firebase config:",{...n,apiKey:"HIDDEN"});let i=null,l=null;try{i=(0,t.Dk)().length?(0,t.Dk)()[0]:(0,t.Wp)(n),l=(0,o.aU)(i),(0,a.xI)(i),console.log("Firebase initialized successfully")}catch(e){console.error("Error initializing Firebase:",e)}},9310:(e,s,r)=>{r.d(s,{Bh:()=>y,CF:()=>n,Lx:()=>a,TK:()=>l,YB:()=>f,dk:()=>m,hG:()=>c,nu:()=>i,ui:()=>d,zO:()=>h});var t=r(5112),o=r(4197);localStorage.removeItem("useMockData"),localStorage.setItem("useMockData","false");let a=async(e,s)=>{try{let r=(0,t.rJ)(o.db,"users"),a=(0,t.P)(r,(0,t._M)("username","==",e)),n=await (0,t.GG)(a);if(n.empty)return console.log("User not found in database:",e),{success:!1,error:"User not found"};let i=n.docs[0].data(),l=n.docs[0].id;if(console.log("Found user:",e,"Checking password..."),i.password!==s)return console.log("Invalid password for user:",e),{success:!1,error:"Invalid password"};console.log("Login successful for user:",e);let c=await u(l);c&&await d(c.id);let m=await g(l,e);return{success:!0,user:{uid:l,sessionId:m,...i}}}catch(e){return console.error("Login error:",e.message),{success:!1,error:"Login failed: "+e.message}}},n=async()=>{try{let e=(0,t.rJ)(o.db,"users");return(await (0,t.GG)(e)).docs.map(e=>({id:e.id,...e.data()}))}catch(e){return console.error("Error getting users:",e.message),[]}},i=async e=>{try{let s={...e,createdAt:(0,t.O5)(),updatedAt:(0,t.O5)()},r=await (0,t.gS)((0,t.rJ)(o.db,"users"),s);return{success:!0,id:r.id}}catch(e){return console.error("Error adding user:",e.message),{success:!1,error:e.message}}},l=async(e,s)=>{try{let r={...s,updatedAt:(0,t.O5)()};return await (0,t.mZ)((0,t.H9)(o.db,"users",e),r),{success:!0}}catch(e){return console.error("Error updating user:",e.message),{success:!1,error:e.message}}},c=async e=>{try{return await (0,t.kd)((0,t.H9)(o.db,"users",e)),{success:!0}}catch(e){return console.error("Error deleting user:",e.message),{success:!1,error:e.message}}},u=async e=>{try{let s=(0,t.rJ)(o.db,"userSessions"),r=(0,t.P)(s,(0,t._M)("userId","==",e),(0,t._M)("active","==",!0)),a=await (0,t.GG)(r);if(a.empty)return null;let n=a.docs[0];return{id:n.id,...n.data()}}catch(e){return console.error("Error checking active session:",e.message),null}},d=async e=>{try{return await (0,t.mZ)((0,t.H9)(o.db,"userSessions",e),{active:!1,logoutTime:(0,t.O5)()}),!0}catch(e){return console.error("Error invalidating session:",e.message),!1}},g=async(e,s)=>{try{let r=new Date,a=r.toISOString().split("T")[0].replace(/-/g,""),n=r.toISOString().split("T")[1].substring(0,8).replace(/:/g,""),i="".concat(e,"_").concat(a,"_").concat(n),l={userId:e,username:s,loginTime:(0,t.O5)(),active:!0,device:navigator.userAgent,ip:"Unknown",createdAt:a+"_"+n};return await (0,t.BN)((0,t.H9)(o.db,"userSessions",i),l),i}catch(e){throw console.error("Error creating user session:",e.message),e}},m=async(e,s)=>{if(!e||!s)return!1;try{let r=await (0,t.x7)((0,t.H9)(o.db,"userSessions",s));if(!r.exists())return!1;let a=r.data();return a.userId===e&&!0===a.active}catch(e){return console.error("Error validating session:",e.message),!1}},h=async(e,s)=>{try{let r=new Date(s);r.setDate(r.getDate()-7);let a=e=>{let s=e.getFullYear(),r=String(e.getMonth()+1).padStart(2,"0"),t=String(e.getDate()).padStart(2,"0");return"".concat(s,"-").concat(r,"-").concat(t)};a(s),a(r);let n=[];for(let e=1;e<=7;e++){let r=new Date(s);r.setDate(r.getDate()-e),n.push(a(r))}let i=(0,t.rJ)(o.db,"wardDataFinal"),l=(0,t.P)(i,(0,t._M)("wardId","==",e),(0,t._M)("date","in",n)),c=await (0,t.GG)(l),u=new Set;if(c.docs.forEach(e=>{let s=e.data();u.add(s.date)}),0===u.size)return{hasData:!1,message:"ไม่พบข้อมูลย้อนหลัง 7 วันที่ผ่านมา กรุณาติดต่อผู้ดูแลระบบเพื่อตรวจสอบ",datesChecked:n,datesWithData:Array.from(u)};return{hasData:!0,message:"พบข้อมูลย้อนหลังในช่วง 7 วันที่ผ่านมา",datesChecked:n,datesWithData:Array.from(u)}}catch(e){return console.error("Error checking last 7 days data:",e.message),{hasData:!1,error:e.message,message:"เกิดข้อผิดพลาดในการตรวจสอบข้อมูลย้อนหลัง 7 วัน"}}},f=async function(e){let s=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,a=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null;try{let n=(0,t.rJ)(o.db,"wardDataDrafts"),i=[(0,t._M)("userId","==",e)];s&&i.push((0,t._M)("wardId","==",s)),r&&i.push((0,t._M)("date","==",r)),a&&i.push((0,t._M)("shift","==",a));let l=(0,t.P)(n,...i),c=await (0,t.GG)(l);if(c.empty)return[];return c.docs.map(e=>({id:e.id,...e.data()}))}catch(e){return console.error("Error getting user drafts:",e.message),[]}},y=async(e,s,r,a)=>{try{let n=(0,t.rJ)(o.db,"wardDataDrafts"),i=(0,t.P)(n,(0,t._M)("userId","==",e),(0,t._M)("wardId","==",s),(0,t._M)("date","==",r),(0,t._M)("shift","==",a)),l=await (0,t.GG)(i);if(l.empty)return null;let c=null,u=0;return l.docs.forEach(e=>{var s;let r=e.data(),t=(null===(s=r.lastUpdated)||void 0===s?void 0:s.seconds)||0;t>u&&(u=t,c={id:e.id,...r})}),c}catch(e){return console.error("Error getting latest draft:",e.message),null}}},9770:(e,s,r)=>{r.d(s,{$s:()=>n});var t=r(9509);let o="app_logs",a=async e=>{try{let s=await fetch("/api/logs",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)});if(!s.ok)throw Error("Server responded with status ".concat(s.status));return!0}catch(e){return console.warn("Failed to send log to server:",e),!1}},n=async function(e){let s=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};try{let r={timestamp:new Date().toISOString(),event:e,properties:s},n=JSON.parse(localStorage.getItem(o)||"[]");n.push(r);let i=n.slice(-1e3);localStorage.setItem(o,JSON.stringify(i)),a(r).catch(e=>{console.warn("Error sending log to server:",e)}),t.env.NEXT_PUBLIC_EXTERNAL_LOGGING_URL&&fetch(t.env.NEXT_PUBLIC_EXTERNAL_LOGGING_URL,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(r)}).catch(console.error)}catch(e){console.warn("Logging failed:",e)}}}}]);